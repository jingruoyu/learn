## HTTPS

### 加密方式

* 对称加密：把秘钥传给对方，双方用同一个秘钥加密解密
* 非对称加密：拥有公钥和私钥，公钥和私钥地位相同

	* 公钥加密，私钥可以解密
	* 私钥加密，公钥即可解密

	但在一般使用中，是按照
	* 服务端使用私钥加密一段消息摘要，客户端使用公钥解密消息摘要
	* 客户端使用公钥加密对称秘钥，服务端用私钥解密，拿到真正的对称秘钥
	双方开始用对称秘钥开始进行加密传输

### HTTPS Secure

HTTPS = HTTP + 加密 + 认证 + 完整性保护

HTTPS的通信接口部分由SSL（Secure Socket Layer）和TLS（Transport Layer Security）代替，即**HTTP先与SSL进行通信，SSL再和TCP进行通信**

* SSL：Secure Socket Layer，安全套接层，位于可靠的面向连接的网络层协议和应用层协议之间的一种协议层
* TLS：Transport Layer Security，安全层传输协议，用于两个应用程序之间提供保密性和数据完整性。该协议由两层组成：TLS记录协议和TLS握手协议

### HTTPs通信步骤

1. 客户端通过发送Client Hello报文开始SSL通信。报文中包含客户端支持的SSL的指定版本、加密组件（Cipher Suite）列表（所使用的加密算法及密钥长度等）
2. 服务器可进行SSL通信时，会以Server Hello报文作为应答。和客户端一样，在报文中包含SSL版本以及加密组件。服务器的加密组件内容是从接收到的客户端加密组件内筛选出来的
3. 之后服务器发送Certificate报文。报文中包含**公开密钥证书**
4. 最后服务器发送Server Hello Done报文通知客户端，最初阶段的SSL握手协商部分结束
5. SSL第一次握手结束后，客户端以Client Key Exchange报文作为回应。报文中包含通信加密中使用的一种被称为Pre-master secret的随机密码串。该报文已用步骤3中的公开密钥进行加密
6. 接着客户端继续发送Change Cipher Spec报文。该报文会提示服务器，在此报文之后的通信会采用Pre-master secret密钥加密
7. 客户端发送Finished报文。该报文包含连接至今全部报文的整体校验值。这次握手协商是否能够成功，要以服务器是否能够正确解密该报文作为判断标准
8. 服务器同样发送Change Cipher Spec报文
9. 服务器同样发送Finished报文
10. 服务器和客户端的Finished报文交换完毕之后，SSL连接就算建立完成。当然，通信会受到SSL的保护。从此处开始进行应用层协议的通信，即发送HTTP请求
11. 应用层协议通信，即发送HTTP响应
12. 最后由客户端端口连接。断开连接时，发送close_notify报文。这步之后再发送TCP FIN报文来关闭与TCP的通信

### HTTPS证书验证

1. 操作系统、浏览器中已经内置了一些根证书，主要是少数几家权威CA机构颁发的证书，证书中有CA的公钥，可以信任
2. HTTPS网站需要先在CA机构申请公钥证书，证书的内容是
	* 相关信息 + 签名
	* 相关信息：公钥、颁发机构、到期时间等
	* 签名：先对相关信息用特定的hash算法得到一个摘要，在对这个摘要使用CA机构的私钥进行加密
3. 拿到CA颁发的证书，存放于服务器
4. 浏览器访问网站，服务器发送公钥给浏览器，浏览器拿到网站的公钥证书后
	1. 使用CA的公钥对证书的签名进行解密，得到一个摘要
	2. 使用相同的hash算法，对网站公钥中的相关信息进行hash得到一个摘要
	3. 两个摘要进行对比验证，相同则标明网站可信任，之后可以直接使用这个公钥
5. 浏览器生成一个随机数字，作为对称秘钥，然后使用公钥加密，发送给服务端
6. 服务端使用私钥解密，获得对称秘钥
7. 之后双方均使用对称秘钥进行通信

此过程在SSL层完成

### charles原理
