## 8 连接

### 8.1 长连接

当不使用长连接时，每次请求url都需要建立单独的TCP连接，此举增加了HTTP服务器的开销并且造成网络拥堵。

使用内联图片和其他一些数据资源往往需要客户端在短时间内向同一个服务端进行多次请求，可以针对此类情况建立长连接，多次请求均在一个TCP/IP连接中进行。实际`HTTP/1.1`实现的实施经验和测量结果都显示出良好的结果，同时其他替代方案也在探索中，如`T/TCP`

**HTTP长连接优点**：
* 减少建立的TCP连接数目，节省路由器和主机的CPU占用，节省主机关于TCP协议控制的内存占用
* 提高单个TCP连接的效率，减少其空闲时间。在一个连接中，HTTP请求和响应可以被流水线操作，允许客户端同时发起多个请求而不必等待每一个的响应。
* 减少网络拥塞。通过减少TCP连接与断开减少网络上的数据包从而减少网络拥塞，同时给与TCP连接足够的时间确定网络拥塞状况
* 后续请求中没有TCP的建立与三次握手，减少请求延迟
* HTTP可以更优雅，当发生错误时可以回传错误信息，而不是直接关闭TCP连接。

总之HTTP协议的实现应该包含长连接

### 8.1.2 整体操作

HTTP/1.1中长连接时任何HTTP连接的默认行为，这是其与更早版本的HTTP协议之间一个标志性的不同。这意味着除非具有特殊声明，客户端应该申请和服务端之间建立长连接，即使服务端返回了一个错误的响应

长连接机制提供了一种机制，客户端和服务端可以通过信号控制TCP连接的关闭，其使用**`Connection`**头字段作为信号。一旦信号发出，客户端在当前连接中禁止再发送任何请求

#### 8.1.2.1 传输

当`Connection`头字段值位close时，长连接将被断开。

* 如果HTTP/1.1服务器希望在返回响应后立即断开长连接，其应该将响应头中`Connection`置为close
* 如果HTTP/1.1客户端希望在本次请求后断开长连接，其应该将请求头中`Connection`置为close

长连接是否保持基于请求与响应中的`Connection`头字段，如果请求或响应任意一方的`Connection`字段为close，则该请求