## 8 连接

### 8.1 长连接（持久连接）

当不使用长连接时，每次请求url都需要建立单独的TCP连接，此举增加了HTTP服务器的开销并且造成网络拥堵。

使用内联图片和其他一些数据资源往往需要客户端在短时间内向同一个服务端进行多次请求，可以针对此类情况建立长连接，多次请求均在一个TCP/IP连接中进行。实际`HTTP/1.1`实现的实施经验和测量结果都显示出良好的结果，同时其他替代方案也在探索中，如`T/TCP`

**HTTP长连接优点**：
* 减少建立的TCP连接数目，节省路由器和主机的CPU占用，节省主机关于TCP协议控制的内存占用
* 提高单个TCP连接的效率，减少其空闲时间。在一个连接中，HTTP请求和响应可以被流水线操作，允许客户端同时发起多个请求而不必等待每一个的响应。
* 减少网络拥塞。通过减少TCP连接与断开减少网络上的数据包从而减少网络拥塞，同时给与TCP连接足够的时间确定网络拥塞状况
* 后续请求中没有TCP的建立与三次握手，减少请求延迟
* HTTP可以更优雅，当发生错误时可以回传错误信息，而不是直接关闭TCP连接。

总之HTTP协议的实现应该包含长连接

#### 8.1.2 整体操作

HTTP/1.1中长连接时任何HTTP连接的默认行为，这是其与更早版本的HTTP协议之间一个标志性的不同。这意味着除非具有特殊声明，客户端应该申请和服务端之间建立长连接，即使服务端返回了一个错误的响应

长连接机制提供了一种机制，客户端和服务端可以通过信号控制TCP连接的关闭，其使用**`Connection`**头字段作为信号。一旦信号发出，客户端在当前连接中禁止再发送任何请求

**传输** 

当`Connection`头字段值位close时，长连接将被断开。

* 如果HTTP/1.1服务器希望在返回响应后立即断开长连接，其应该将响应头中`Connection`置为close
* 如果HTTP/1.1客户端希望在本次请求后断开长连接，其应该将请求头中`Connection`置为close

长连接是否保持基于请求与响应中的`Connection`头字段，如果请求或响应任意一方的`Connection`字段为close，则该请求是当前连接中的最后一个请求

除非有特殊声明，否则当HTTP版本低于1.1时，客户端与服务端不应该采用长连接

为了保持长连接，连接中的所有消息都必须包含一个自定义的消息长度，如4.4中所述，当有一条消息未携带此字段，连接会被关闭

**流式处理（流水线技术）**

支持长连接的客户端也许会对其请求做流式处理，即可以连续发送多个请求不用等待其响应，**服务器必须按照收到请求的顺序发送其对应的响应**

* 支持长连接和流式处理的客户端，在连接建立后，如果第一次流处理失败，应该立刻重试连接
* 如果客户端进行了这样的重试，其必须知道当前连接是长连接后才会进行流式处理
* 如果服务端在发送完所有响应前关闭了连接，客户端必须重发这些请求

客户端不应该使用流式处理发送使用非幂等的请求方法或非幂等性序列的请求方法，否则过早的终止连接将会带来不可知的结果。如果客户端想要发送一个非幂等请求，应该等之前请求响应都接收到之后再发送

幂等请求方法：一种HTTP方法，多次调用不会产生不同的结果

#### 8.1.3 代理服务器

代理服务器必须与其连接到的客户端和源服务器（或者其他代理服务器）分别维持长连接，每个长连接都会单独占用一个传输链路

代理服务器禁止与一个HTTP/1.0的客户端建立HTTP/1.1的长连接（不过很多HTTP/1.0客户端使用`Keep-Alive`头字段，这也带来了一些问题[RFC 2068](https://tools.ietf.org/html/rfc2068)）

HTTP/1.0中视图使用`Keep-Alive`实现长连接，但是其中存在问题，部分客户端会盲目向代理服务器发送该请求头导致连接被挂起不能释放，故被废弃，目前HTTP/1.0中使用`Connection`头标志是否进行长连接

	Connection: Keep-Alive

#### 8.1.4 实践中的注意事项

当服务器通常会有一些timeout超时值，超过这个值服务器将不在保持不活动的连接。由于客户端和同一个服务端之间可能会同时存在多个连接，所以代理服务器可能会将这个值变得更大。**使用长连接的地方无需使用timeout，无论是对客户端或服务器**

当客户端或服务端希望将连接超时中断时，其应该被优雅的关闭，客户端与服务端应该不断监听另一侧的连接状况，并且做出适当响应。如果不及时检测另一端的连接状态，可能会造成网络上不必要的资源浪费

请求链中的任意一方都可能在任何时刻关闭连接，如一方在关闭的同时另一方正好在发送，因此需要各方必须能够从异步的关闭事件中恢复过来。

在客户端中
* 如果请求序列是幂等的，应该重新开启传输连接，并重新发送被中断的请求，无需用户干预
* 如果请求方法或请求序列是非幂等的，禁止自动重发

如果第二次重发仍失败，不应该继续重发请求序列

* 对于服务端

	如果可能的话，在每个连接中服务端应该至少响应一个请求。

	除非怀疑网络或客户端报错，服务端不应该在发送响应途中关闭连接

使用长连接时，客户端应该限制与给定服务器的并行连接数。（以下两规则紧密相连）
* 单用户客户端与任何服务器或代理的连接不应该超过两个
* 一个代理与其他另一个服务器或代理间应该最多使用`2*N`个连接，N为同时活动的用户数

这些注意事项都是为了提高HTTP的响应时间，避免网络拥塞。

### 8.2 信息传递要求

#### 8.2.1 长连接和流控制

HTTP/1.1中服务端应该维持长连接并且**使用TCP的流控制解决临时负载过重问题**，而不是关闭连接等待客户端重连，否则会恶化网络拥塞情况

