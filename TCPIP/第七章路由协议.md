## 路由协议

路由控制协议根据路由控制表转发数据包

* 静态路由：事先设置好路由器和主机并将路由信息固定
* 动态路由：让路由协议在运行过程中自动地设置路由控制信息

两种方式各有利弊，可以结合使用

### 7.2 路由控制范围

* EGP（Exterior Gateway Protocol)：外部网关协议，在区域网络之间（或ISP之间）进行路由选择，使用BGP协议
* IGP（Interior Gateway Protocol）：内部网关协议，在区域网络内部（或ISP内部）进行主机识别，使用RIP、RIP2、OSPF等协议

### 7.3 路由算法

#### 7.3.1 距离向量算法

根据**距离（代价）**和**方向**决定目标网络或目标主机未知的一种方法，代价相当于要经过的路由器个数

路由器之间可以交换目标网络的方向及其距离的相关信息，并以这些信息为基础制作路由控制表，每个路由器的路由控制表不同
* 处理简单
* 网络拓扑复杂时耗时较大
* 容易发生路由循环

#### 7.3.2 链路状态算法

路由器在了解网络整体连接状态的基础上生成路由控制表的一种方法。该方法中，每个路由器必须保持同样的信息才能进行正确的路由选择
* 网络结构复杂时也可以快速达到稳定状态
* 管理和处理信息需要高速CPU和大量内存

### 7.4 RIP

Routing Information Protocol，距离向量型的一种路由协议，广泛用于LAN

#### 7.4.1 广播路由控制信息

1. 将路由控制信息定期（30秒一次）向全网广播
2. 如果没有收到路由控制信息，等待5次，第6次仍未收到，连接就会被断开

#### 7.4.2 基于距离向量确定路由

距离（Metrics，单位：跳数，即所经过的路由器的个数），RIP希望尽可能少通过路由器将数据包转发到目标IP地址

1. 根据距离向量生成距离向量表
2. 抽出较小的路由生成最终的路由控制表，如果距离相同，通常是随机选择或者轮换使用

#### 7.4.3 使用子网掩码时的RIP处理

从接口IP地址对应**分类**得出网络地址后，与根据路由控制信息流过此路由器的包中的IP地址对应的**分类**得出的网络地址进行比较
* 如果两者网络地址相同，以**接口的网络地址**为准
* 如果两者网络地址不同，以**IP地址的分类所确定的网络地址**为准

#### 7.4.4 RIP中路由变更时的处理

基本行为：
* 将自己所知道的路由信息定期广播
* 一旦认为网络被断开，数据无法流过，其他路由器由此可知网络已断开

存在问题：无限计数，RIP信息在两个路由器之间互相转发，跳数不断增加

初步解决方式：
* 最长距离不超过16，设置最大跳数
* 水平分割：规定路由器不再把收到的路由信息原路返回给发送端

但是无法解决存在环路的情况，因此进一步采用**毒性逆转**和**触发更新**，在链路不通时可以迅速传递消息使路由消息收敛

* 毒性逆转：当网络中发生链路断开时，将无法发送通信的消息传播出去，即发送一个距离为16的消息
* 触发更新：当路由信息发生变化时，不等待30s，而是立即发送出去

#### 7.4.5 RIP2

* 与RIP工作机制基本相同
* 使用多播：减少网络流量，缩小对无关主机影响
* 支持子网掩码，RIP只支持分类地址
* 路由选择域：在同一个网络中使用逻辑上独立的多个RIP
* 外部路由标志：通常用于把从BGP等获得的路由控制信息通过RIP传入自治系统
* 身份验证秘钥

但是在一个复杂的网络环境中，路由信息达到稳定状态需要一定时间，解决此问题必须明确掌握网络结构，为此可以采用OSPF

### 7.5 OSPF

Open Shortest Path First，链路状态型路由协议
* 采用链路状态类型，可解决环路问题
* 支持子网掩码
* 引入路由选择域，减少协议间不必要交换

#### 7.5.1 OSPF是链路状态型路由协议

1. 路由器之间交换链路状态信息生成网络拓扑信息
2. 根据拓扑信息生成路由控制表

OSPF对每条链路赋予一个权重，始终选择权重最小的路径作为最终路由。
* RIP选择跳数最小的路径
* OSPF选择总代价最小的链路

#### 7.5.2 基础知识

OSPF中，不需要在所有的相邻路由器之间进行控制信息的交换，而是确定一个指定路由器，以他为中心交换路由信息即可

OSPF中有五种类型的包：
* 问候HELLO，用于确认是否连接
* 数据库描述Database Description，互相发送路由摘要信息和版本信息
* 链路状态请求Link State Request，如果版本比较老，首先发送该包请求路由控制信息
* 链路状态更新Link State Update，然后使用更新包接收路由状态消息
* 链路状态确认Link State ACK Package，最后使用确认宝通知大家本地已经接收到路由控制信息

相比RIP只有路由控制信息包，可以大大减少网络流量，迅速更新路由信息

#### 7.5.3 工作原理

* LAN中每十秒发送一个HELLO包，允许空等三次，第四次仍无反馈认为连接断开，进行连接断开或恢复连接操作
* 由于链路状态发生变化，会发送链路状态更新包通知其他路由器网络状态变化。

	其中包含两类消息：
	* 网络LSA：以网络为中心，表明网络与哪些路由器相连
	* 路由器LSA：以路由器为中心，表明路由器与哪些网络相连

* 根据上面消息生成链路状态数据库
* 根据数据库，使用最短路径优先算法生成路由控制表

缺点：网络规模扩大时，算法处理的时间较长，对CPU和内存消耗较大

#### 7.5.4 区域分层

问题：网络规模扩大，链路状态数据库过大，路由控制信息计算困难

解决办法：引入区域概念，将一个自治系统划分为多个区域与一个主干区域，其他区域都与主干区域相连

* 每个区域内的路由器都持有本区域网络拓扑的数据库
* 区域外的路径信息，只能从区域边界路由器获知距离

### 7.6 BGP

Border Gateway Protocol，边界网关协议用于连接不同组织机构，路径向量型协议，属于EGP

组织会为每个BGP分配一个16比特的AS编号，BGP根据这个编号进行路由控制

BGP使用AS作为度量标准，一般选择AS数最少的路径，但也要遵循各个AS之间签约的细节进行更细粒度的路由选择

在AS路径信息访问列表中不仅包含转发方向和距离，还涵盖了途径的所有AS编号

**路由控制是跨越整个互联网的分布式系统**

### 7.7 MPLS

Multi Protocol Label Switching，多协议标记交换技术

* 路由交换：基于IP地址中最长匹配原则进行转发
* 标记交换：对每个IP包设定一个标记，然后根据这个标记进行转发

#### 基本操作

* LSR：Label Switching Router，标记交换路由器，实现MPLS功能的路由器
* LER：Label Edage Router，标记边缘路由器，与外部网络连接的那部分LSR，进行追加标记和删除标记

MPLS中目标地址和数据包都要通过由标记决定的同一个路径，即标记交换路径LSP，Label Swithing Path

优点：
* 转发速度快，使用固定长度的标记信息，处理简单
* 利用标记生成虚拟路径，IP协议利用其可以提供质量控制、带宽保证和VPN等功能

## 总结

* AS，EGP与IGP，距离向量算法与链路状态算法
* RIP，基于距离向量确定路由
	* 选择跳数最小的路径
	* 无法使用子网掩码，网络地址的确定
	* 路径变更时处理，定期广播，无限计数，毒性逆转，水平分割
	* RIP2区别，使用多播，子网掩码，路由选择域
* OSPF，基于链路状态确定路由
	* 选择总代价最小的路径
	* 五种包，减少网络流量
	* 链路状态变化，更新链路状态数据库，最短路径算法生成路由转发表
	* 区域分层，减少每个区域规模
* BGP，边界网关协议，根据AS编号进行转发，选择AS最小的路径
* MPLS，多协议标记交换技术
	* 根据标记交换
	* 速度快，生成虚拟路径，为IP协议提供质量保证