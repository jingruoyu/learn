## 数据链路

着重介绍TCP/IP中的具体数据链路，以太网、无线局域网、PPP

### 3.1 数据链路的作用

数据链路层协议定义了通过通信媒介互联的设备之间传输的规范

数据链路的段是指一个被分割的网络，但是从不同的视角观察，分割标准不同。
* 从物理层角度，一条网线即为一个段
* 从网络层角度，通过中继器可以将物理层上处于不同段的网络相连接，组成一个段

网络拓扑即为网络的连接和构成形态，包括总线型、星型、环型、网状型等。拓扑不仅用于直观的配线方式，也用于逻辑上网络的组成结构，二者有时可能不一致。

### 3.2 网络链路相关技术

#### 3.2.1 MAC地址

MAC地址用于识别数据链路层中互联的节点，任何一个网卡的MAC地址都是唯一的，网卡的MAC地址直接烧入ROM中

MAC地址长48比特，即48位，6个字节
* 第1位：单播地址（0），多播地址（1）
* 第2位：全局地址（0），本地地址（1）
* 第3-24位：厂商识别码，IEEE管理，各厂商不重复
* 第25-48位：厂商内部识别码，厂商各产品不重复

#### 3.2.2 共享介质网络

从通信介质的使用方式上，网络可以分为共享介质型和非共享介质型

共享介质型网络由多个设备共享一个通信介质，由于设备之间使用同一个载波信道进行发送和接收，所以基本上采用**半双工通信**，需要对介质进行访问控制。访问控制方式有争用方式与令牌传递方式。

* 争用方式

不同节点争夺获取数据传输权利，也称载波监听多路访问CSMA。网络中各个节点采用先到先得的方式占用信道发送数据，如果多个节点同时发送帧，则会产生冲突现象。导致网络拥堵性能下降。

后来部分以太网采用**`CSMA/CD`**，即每个节点提前检查冲突，一旦发生冲突，尽早释放信道

* 令牌传递方式

沿着令牌环发送一种叫做令牌的特殊报文，只有获得令牌的节点才能发送数据。

优点：
* 不会产生冲突
* 每个节点都有通过平等循环获得令牌的机会

故即使网络拥堵也不会造成性能下降，但是可能会降低网络利用率，为此衍生了多种令牌使用方式尽可能提高网络利用率。

令牌环网中，当目标节点接收到数据后，会设置数据的‘已接收数据’标志位，然后沿着环继续转发下去。当数据帧回到发送源后会被丢弃，然后令牌沿着环传递给下一个节点。

#### 3.2.3 非共享介质网络

非共享介质网络是指不共享介质，是对介质采取专用的一种传输控制方式。

此情况下，每个节点直连交换机，由交换机负责转发数据帧。由于发送端与接收端不共享通信介质，所以可以采用**全双工通信**，并且不会产生冲突。

非共享介质网络的核心为交换机，可以利用其高级特性构建虚拟局域网（VLAN）、进行流量控制等

#### 3.2.4 根据MAC地址转发

共享介质网络规模扩大，性能会明显下降，需要使用交换集线器，也称为以太网交换机，将非共享介质网络中使用的交换机应用在以太网中。

以太网交换机是持有多个端口的网桥，其会参考转发表，根据每个数据帧的目标MAC地址决定从哪个网络端口发送数据。

**转发表可以根据交换机自学生成**

* 数据链路层每个通过点在接收到包时，会将包的源MAC地址和接收该地址发送数据包的接口作为对应关系记录到转发表中，此时即可获知该MAC地址与该端口相连。故以该MAC地址作为目标地址的包，经由该接口送出即可。
* 当数据帧的目标MAC地址不确定端口时，交换机会向所有的端口发送数据帧

MAC地址没有层次性，当设备数量增多，转发表也会随之变大，检索转发表的时间也会变长。故当连接多个终端，建议将整个网络分为多个数据链路，使用类似于IP地址一样对地址进行分层管理

交换机转发方式：

* 存储转发：检查以太网数据帧末尾的FCS位后再进行转发，避免转发错误帧
* 直通转发：只需要得知目标地址即可开始转发，优势在于延迟较短，但是具有发送错误帧的可能性

#### 3.2.5 环路检测技术

通过网桥连接网络，如果网络中存在环路，最坏的情况下数据帧会在环路中持续转发，当这种数据帧积累较多时会导致网络瘫痪。所以需要解决网络的环路问题。

解决环路问题有**生成树**与**源路由**两种方式。网桥具有此功能后，只要搭建合适环路，就可以分散网络流量，绕行故障路由，提高容灾能力。

* 生成树协议STP

	每个网桥必须在每1-10秒内相互交换BPDU包(Bridge Protocol Data Unit)，从而判断哪些端口使用哪些端口不使用，以便消除环路。一旦发生故障，则自动切换通信线路，利用那些没有被使用的端口继续进行传输。

	BPDU是运行STP的交换机之间交换的消息帧，其中包含了STP所需的路径和优先级信息。网桥会为每个端口存储其收到的最佳BPDU，当有其他BPDU到达交换机端口时，会判断其是否比原来的好，如果好则替换掉原有值。

	**RSTP**：快速生成树协议，STP协议发生故障时切换较慢，RSTP可以更快的收敛网络

* 源路由法

	源路由法中判断发送数据的源地址是通过哪个网桥进行传输，将该网桥信息写入数据帧的**RIF**(Routing Information Field)字段中。网桥根据RIF信息发送帧给目标地址。

	故即使网桥中出现环路，数据帧也不会被重复转发，但是要求发送端本山具备源路由功能

#### 3.2.6 VLAN

网桥按照其端口区分了多个网段，通过网段可以对广播数据的传播范围进行限制，减少网络负载提高安全性

VLAN指无需更改网络拓补结构，通过网桥的的网段划分，修改网络结构，即可切断不同VLAN之间的通信，过滤多余的包

但是异构的两个网段之间想要实现通信，需要利用具有**路由功能**的交换机或在各段之间通过路由器连接才能实现

### 3.3 以太网

#### 3.3.2 以太网分类

* 传输速度相同情况下，可以使用中继器或集线器连接不同的传输介质
* 传输速度不同情况下，必须采用允许变更速度的设备如网桥、以太网交换机或路由器连接不同传输介质

计算机内部采用二进制，但是**以太网的传输速率采用十进制**

以太网规定了通信电缆的类型

#### 3.3.4 以太网帧格式

* 前导码：长度8字节，表示一个以太网帧的开始，也是对端网卡能够确保与其同步的标志

	前导码的末尾是两个比特的SFD，值为11，SFD之后是以太网的本体

* 以太网帧本体
	* 目标MAC地址：6字节
	* 源MAC地址：6字节
	* 上层协议类型：2字节
	* 数据：46-1500字节
	* FCS校验位：4字节，检查帧是否有所损坏

		接收端会对整个帧进行相同的运算，如果得出的FCS与以太网帧中的FCS相同，则说明接收到的帧没有差错

IEEE802.3 Ethernet 和一般的以太网的帧在首部上稍有区别，在上层协议类型的位置有一定不同

数据链路层可以细分为两层：
* 介质访问控制层：根据不同数据链路所**特有**的首部信息进行控制
* 逻辑链路控制层：根据不同数据链路所**共有**的首部信息进行控制

### 3.4 无线通信

#### 3.4.1 无线通信的种类

* 短距离无线
* 无线PAN（802.15）：蓝牙，频率2.4GHz，通信终端最多允许八台设备
* 无线LAN（802.11）：wifi
* 无线MAN（802.16）：WIMAX
* 无线RAN
* 无线WAN：手机通信，3G、4G、LTE等

#### 3.4.2 802.11

IEEE802.11定义了无线LAN协议中物理层与数据链路层的一部分，是所有IEEE802.11相关协议的基础

* MAC层中物理地址与以太网相似，均使用MAC地址
* 介质访问控制使用CSMA/CA，其与CSMA/CD相似
* 物理层上使用电磁波或红外线进行通信

IEEE802.11协议族

* IEEE802.11b与IEEE802.11g

	物理层使用2.4GHz频段，最大传输速度分别可以达到11Mbps和54Mbps。不过其使用频段与微波炉使用频段相同，容易受到干扰

* IEEE802.11a

	物理层使用5GHz频段，最大传输速度54Mbp，不易受到干扰。

	其与IEEE802.11b/g存在一定兼容性问题

* IEEE802.11n

	在IEEE802.11g和IEEE802.11a的基础上，采用同步多条天线的MIMO技术，实现高速无线通信。

	物理层使用2.4GHz与5GHz，当不受其他2.4G频段系统干扰时，可以达到以上协议的数倍带宽40MHz，最大传输速度150Mbps

* IEEE802.11i

	使用增强型的加密技术

### 3.5 PPP

#### 3.5.1 PPP定义

即Point-to-Point，点对点协议，一对一连接计算机的协议，位于数据链路层

* 以太网和FDDI不仅与数据链路层有关，也与物理层有关，以太网需要使用同轴电缆或双绞线电缆，可以决定其中的0/1该被解释为何种电子信号
* **PPP是纯粹的数据链路层协议，与物理层无关，可以搭配各种各样的物理层**

当前实现互联网介入的主要方式
* ADSL
* PPPoE：PPP over Ethernet，在以太网的数据中加入PPP帧进行传输

#### 3.5.2 LCP与NCP

开始进行数据传输前，需要先建立一个PPP级的连接

PPP的主要功能包括两个协议：
* LCP：Link Control Protocol，不依赖上层

	LCP主要负责建立和断开连接、设置最大接收单元、设置验证协议（PAP或CHAP）以及设置是否进行通信质量的监控

* NCP：Network Control Protocol，依赖上层。如果上层为IP，则NCP也称为IPCP

	IPCP负责IP地址设置以及是否进行TCP/IP首部压缩等设置

通过PPP连接时，通常需要进行用户名和密码的验证，并且对通信两端进行双方向验证。验证协议有PAP和CHAP
* PAP：通过两次握手进行验证，其中密码明文传输，安全性不高
* CHAP：使用一次性密码OTP，有效防止窃听，建立连接后定期密码交换，检验对端是否被中途替换

#### 3.5.3 PPP帧格式

PPP协议基于HDLC协议，二者在帧格式方面十分相似

* 在每个帧的前后加上8位`01111110`的标志码区分帧，两个标志码之间不允许出现连续6个以上的1

* 在发送帧时，当出现连续5个1时后面必须插入一个0，在接收帧时，当收到连续5个1且后面跟着的是0，就必须删除0

使用**标志码**区分帧的启示与终止

上述工作和FCS的计算都会交由计算机CPU处理，故PPP的使用会为计算机带来大量负荷

#### 3.5.4 PPPoE

有些互联网接入商利用PPPoE提供PPP功能，通信线路由以太网模拟，服务由PPP提供

PPP帧作为以太网的数据传输，PPP首部在PPP帧的最前端

### 3.6 其他数据链路

以太网、无线通信、PPP

#### 3.6.1 ATM

ATM(Asynchronous Transfer Mode)是以信元（5字节首部，48字节数据）为单位进行传输数据链路，特点为线路占用时间短，高效传输大容量数据

特点：
* **ATM是一种面向连接的数据链路**，需要在通信传输前设置通信线路。
* ATM允许同时与多个对端建立通信连接
* ATM中增加了限制带宽的细分功能

	ATM没有类似于以太网中的介质访问控制，允许在任何时候发送任何数据，容易诱发网络拥堵甚至网络进入收敛状态，因此ATM中需要限制带宽

	网络收敛状态：网络十分拥堵时，路由器或交换机无法完成包的处理，从而丢弃这些包的一种状态

**传输模式**

ATM采用异步传输模式，在TDM的基础上进行扩展，不使用固定时隙，按照包到达的顺序进行传输，使用5字节首部标识具体的通信类型，其中包含相应识别码，识别码是在直连的两个ATM交换机之间有效。

ATM信元传输所占时隙不固定，一个帧所占的时隙数也不固定，时隙之间不要求连续，故可以有效避免TDM带来的空闲时隙问题，提高线路利用率。

不过额外使用首部增加了网络开销，也在一定程度上降低了通信速度

* ATM交换机仅进行信元转发
* 与ATM交换机相连的超出ATM网络的其他设备进行信元的拼接，恢复其原来的数据包

**ATM与上层协议**

ATM一个信元只能发送固定48字节数据，传输上层数据是需要进行分割传输。而IP首部和TCP首部均为20字节，此时需要用到AAL(ATM Adapter Layer)以适配上层协议，在上层为IP时，叫做AAL5

由于整个IP包被分割为多个ATM信元，一个信元丢失就会导致整个IP包被损坏，从而导致所有信元被丢弃重传，从而诱发网络收敛。故ATM网络在构建时，必须保证终端的带宽合计小于主干网的带宽，并且信元不易丢失。

#### 3.6.3 FDDI

分布式光纤数据接口，早期为使用光纤和双绞线实现100Mpbs传输速率而使用的数据链路，随着高速LAN的使用，逐渐被抛弃

#### 3.6.4 HDMI

高清晰度多媒体接口，通过一根缆线实现图像和声音等数字信号的高品质传输。**目前也可以传输以太网帧**

### 3.7 公共网络

#### 3.7.1 模拟电话线路

利用固定电话线路进行通信，其中的音频带宽用于拨号上网，已逐渐被淘汰

#### 3.7.3 ADSL

对模拟电话线路进行拓展，通过调制将电话音频信号与数据传输信号隔离，避免产生干扰，类似的通信方式统称XDSL

#### 3.7.4 FTTH

* Fiber To The Home，光纤到户，通过ONH将计算机与光纤相连，ONH负责光信号与电信号的转换，实现稳定高速上网
* Fiber To The Building
* Fiber To The Curb

#### 3.7.7 VPN

VPN虚拟专用网络用于连接距离较远的地域

* IP-VPN

	在**IP层**上建立VPN

	在IP层使用MPLS(多协议标签交换技)构建VPN服务，MPLS在IP包中附加一个叫做标签的信息进行传输控制，每个用户标签信息不同，在经过MPLS时即可判断出目的地址

* 广域以太网

	在**数据链路层**建立VPN

	在作为数据链路层的以太网上利用VLAN虚拟局域网实现VPN，但是由于使用数据链路层技术，可能会导致一些不必要的信息传输，需要谨慎使用

#### 3.7.8 公共无线LAN

## 总结

第三章主要介绍了数据链路层的内容，主要内容包括
* **MAC地址的划分**
* 共享介质网络与非共享介质网络下不同线路资源使用方式
* **交换机的自学原理**，转发表的生成
* 以太网，数据链路层+物理层，**以太网帧格式**，前导码，MAC地址，协议类型，数据，FCS
* 无线通信
* PPP点对点协议，数据链路层协议，连接与断开，身份验证，PPP帧
* 其他数据链路层