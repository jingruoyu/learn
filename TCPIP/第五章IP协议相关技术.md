## IP协议相关技术

实际通信中，仅依靠IP协议远远不够，还需要众多支持IP的相关技术才能实现最终通信

### 5.2 DNS

IP地址不便于记忆，平时不会直接使用IP地址，而是使用一个字符串，DNS将字符串转化为IP地址

`TCP/IP`刚开始为每个主机指定唯一的主机识别码，进行网络通信时直接使用主机名即可，系统会将主机名转换为具体的IP地址。主机名与IP地址的对应关系存储在hosts数据库文件中，网络中每接入一台主机就需要更新hosts文件

但是随着网络规模扩大，使用单一hosts文件可行性太低

#### 5.2.2 DNS的产生

DNS（Domain Name System）系统主机管理机构负责维护一个主机名与IP地址之间对应关系的**数据库**

用户输入主机名时，DNS会自动在数据库中检索定位其对应的IP地址。并且需要并更主机名与IP地址对应关系时，在组织机构内部进行处理即可，可以在一个较小的范围内对网络进行管理

#### 5.2.3 域名的构成

* 顶级域名：包括国别顶级域名、通用顶级域名等
* 分层域名：在顶级域名下，可以有多层域名

**域名服务器**：管理域名的主机和相应的软件，根部所设置的DNS叫做根域名服务器

每层域名服务器都注册着再往下一层域名服务器的IP地址，如果下面没有其他分层，就可以自由指定主机名称或子网名称

当需要修改域名服务器的名称或IP地址时，需要在其上层的域名服务器中进行追加或修改

域名和域名服务器需要分层设置，如果服务器宕机，则无法进行DNS查询，故为了提高容灾能力，一般会设置多个域名服务器

**所有域名服务器都必须注册根域名服务器的IP地址**，DNS进行IP检索时，是从根域名服务器开始的

**解析器**：进行DNS查询的主机和软件叫做解析器，其必须至少注册一个以上域名服务器的IP地址，才可以进行DNS查询

#### 5.2.4 DNS查询过程

1. 向DNS服务器查询域名的IP地址
2. 在接收查询请求的DNS服务器中，会先在自己的数据库中查找
	1. 如果查询到，直接返回
	2. 如果未查询到，则向上一层根域名服务器进行查询。根域名服务器返回其存储的主域名的DNS服务器IP地址。
	3. DNS服务器再向步骤2中拿到的DNS服务器请求域名的IP地址。
	4. 重复步骤2与步骤3，直至拿到域名的IP地址，返回给客户端
3. 客户端与对应域名开始通信

解析器和DNS服务器将最新了解到的信息暂时保存在缓存中，减少每次查询的性能消耗

**DNS系统如同互联网中的分布式数据库**，其中也存储了一些别的信息

### 5.3 ARP

在数据链路层通信需要了解每一个IP地址所对应的MAC地址

`ARP`是一种解决地址问题的协议，以目标IP地址为线索，用来定位下一个应该接收数据分包的网络设备对应的MAC地址。

`ARP`只适用于`IPv4`，`IPv6`下使用`ICMPv6`代替`ARP`发送邻居探索消息

#### 5.3.2 ARP工作机制

ARP借助ARP请求与ARP响应两种类型的包确定MAC地址

* 源主机广播发送ARP请求包，请求目标主机MAC地址
* 目标主机收到后，将自身MAC地址通过ARP响应返回给源主机

为节约网络流量，可以将收到的MAC地址与IP地址对应关系缓存在ARP缓存表中，下次无需再次发送ARP请求。每次执行ARP时，对应的缓存内容会被清除。在接收ARP请求的主机上，也可以对源主机的MAC地址和IP地址进行缓存，提高效率。缓存具有一定期限，超过期限后，缓存内容将被清除

ARP可以动态进行MAC地址解析，在TCP/IP网络中只要有IP地址即可，无需事先知道MAC地址

#### 5.3.3 IP地址与MAC地址关系

IP地址与MAC地址相互依托

* MAC地址实现数据包在数据链路层的传输，数据链路层使用MAC地址进行传输，MAC地址决定数据包的下一个路由器
* IP地址实现数据包在网络层的传输，网络层可以根据IP地址的网络标识进行层层分组，建立集约机制，减轻交换机压力，实现网络正常通信

#### 5.3.4 其他概念

RARP：反向ARP，即根据MAC地址定位IP地址，需要先架设一台RARP服务器，注册相应MAC地址的IP地址，再于对应MAC地址的设备进行通信，通知其IP地址。

代理ARP：ARP包会被路由器隔离，采用代理ARP的路由器可以将ARP请求转发给临近的网段。由此，两个以上网段的节点可以像在同一个网段中一样通信

### 5.4 ICMP

#### 5.4.1 辅助IP的ICMP

ICMP用于确认网络是否正常工作，以及遇到异常时进行问题诊断

ICMP主要功能：
* 确认IP包是否成功送达目标地址
* 通知在发送过程中IP包被废弃的具体原因，如路径MTU发现
* 改善网络设置等

ICMP消息分类：
* 通知出错原因的错误消息
* 用于诊断的查询消息

#### 5.4.2 主要的ICMP消息

* ICMP目标不可达消息

	IP路由器无法将IP数据包发送给目标地址时，会向发送端主机返回一个目标不可达的ICMP消息，并在其中显示不可达的具体原因

* ICMP重定向消息

	如果路由器发现发送端主机使用次优路径发送数据，其会返回一个ICMP重定向消息，其中包含了最优的路由信息和源数据。下次发送时，发送端主机会直接使用最优路径

	但是但部分情况下，此类消息会引发网络问题，一般不使用

* ICMP超时信息

	TTL为0时，数据包会被丢弃，路由器向发送端返回ICMP超时消息，通知数据包被丢弃

	使用TTL可以控制数据包到达的范围，避免IP包无休止的在网络上被转发

	traceroute应用利用ICMP超时消息，将TTL从1开始递增，获取发送端到接收端整个路径上的路由器IP地址

* ICMP回送消息

	用于进行通信的主机或路由器之间，判断所发送的数据包是否已经成功到达对端的一种消息。

	可以像对端主机发送回送请求的消息ICMP Echo Request Message，也可以接受对端主机发送回来的回送应答消息ICMP Echo Reply Message，ping命令即通过此种方式实现

* ICMP原点抑制消息：一般不使用
* ICMP路由器探索消息

	用于发现与自己相连网络中的路由器，主机发出ICMP路由器请求，路由器返回ICMP路由器公告消息

* ICMP地址掩码消息

	主要用于主机或路由器想要了解子网掩码的情况，向目标主机发出请求消息，接受应答消息

#### 5.4.4 ICMPv6

ICMP在IPv4中仅为辅助作用，但在IPv6中地位更加重要，起到决定性作用

IPv6中的ICMP分为错误消息（0-127）和信息消息（128-255）两种

**邻居探索协议**

邻居请求消息用于查询IP地址与MAC地址的对应关系，并由邻居宣告地址得知MAC地址，使用IPv6的多播地址实现传输

IPv6实现了即插即用，所以没有DHCP服务器也可以实现IP地址的自动获取。
* 没有路由器的网路，使用MAC地址作为链路本地单播地址
* 有路由器的网路，从路由器获得IP地址的前面部分，后面64位有MAC地址进行生成。关于路由器的部分可以使用路由器请求消息与路由器宣告消息进行设置

### 5.5 DHCP

DHCP：只要接入网络，即可自动获取TCP/IP通信所必需的设置，即插即用

#### 5.5.2 工作机制

1. 主机的DHCP客户端向DHCP服务器请求设置IP地址和子网掩码（广播）
2. DHCP服务器通知可以使用的网络设置（单播）
3. 客户端通知想要使用得到的网络设置（广播）
4. 服务器允许使用（单播）

IP地址的分配方式有随机挑选与根据MAC地址固定匹配两种，可以同时使用

DHCP故障会导致整个网段无法进行TCP/IP通信，因此一般架设两台及以上服务器

#### 5.5.3 DHCP中继代理

DHCP中继代理使用一个DHCP服务器，然后在每个网段上设置其DHCP中继代理，可以在服务器上注册每个网段IP地址的分配范围，进行统一管理与维护

* DHCP客户端向DHCP中继代理发送DHCP请求包（广播）
* DHCP中继代理将广播包发给DHCP服务器（单播）
* 服务器向DHCP中继代理返回应答（单播）
* DHCP中继代理将应答转发给客户端（单播）

从而实现**不在一个数据链路上也可以统一分配和管理IP地址**