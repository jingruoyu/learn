## IP协议相关技术

实际通信中，仅依靠IP协议远远不够，还需要众多支持IP的相关技术才能实现最终通信

### 5.2 DNS

IP地址不便于记忆，平时不会直接使用IP地址，而是使用一个字符串，DNS将字符串转化为IP地址

`TCP/IP`刚开始为每个主机指定唯一的主机识别码，进行网络通信时直接使用主机名即可，系统会将主机名转换为具体的IP地址。主机名与IP地址的对应关系存储在hosts数据库文件中，网络中每接入一台主机就需要更新hosts文件

但是随着网络规模扩大，使用单一hosts文件可行性太低

#### 5.2.2 DNS的产生

DNS（Domain Name System）系统主机管理机构负责维护一个主机名与IP地址之间对应关系的**数据库**

用户输入主机名时，DNS会自动在数据库中检索定位其对应的IP地址。并且需要并更主机名与IP地址对应关系时，在组织机构内部进行处理即可，可以在一个较小的范围内对网络进行管理

#### 5.2.3 域名的构成

* 顶级域名：包括国别顶级域名、通用顶级域名等
* 分层域名：在顶级域名下，可以有多层域名

**域名服务器**：管理域名的主机和相应的软件，根部所设置的DNS叫做根域名服务器

每层域名服务器都注册着再往下一层域名服务器的IP地址，如果下面没有其他分层，就可以自由指定主机名称或子网名称

当需要修改域名服务器的名称或IP地址时，需要在其上层的域名服务器中进行追加或修改

域名和域名服务器需要分层设置，如果服务器宕机，则无法进行DNS查询，故为了提高容灾能力，一般会设置多个域名服务器

**所有域名服务器都必须注册根域名服务器的IP地址**，DNS进行IP检索时，是从根域名服务器开始的

**解析器**：进行DNS查询的主机和软件叫做解析器，其必须至少注册一个以上域名服务器的IP地址，才可以进行DNS查询

#### 5.2.4 DNS查询过程

1. 向DNS服务器查询域名的IP地址
2. 在接收查询请求的DNS服务器中，会先在自己的数据库中查找
	1. 如果查询到，直接返回
	2. 如果未查询到，则向上一层根域名服务器进行查询。根域名服务器返回其存储的主域名的DNS服务器IP地址。
	3. DNS服务器再向步骤2中拿到的DNS服务器请求域名的IP地址。
	4. 重复步骤2与步骤3，直至拿到域名的IP地址，返回给客户端
3. 客户端与对应域名开始通信

解析器和DNS服务器将最新了解到的信息暂时保存在缓存中，减少每次查询的性能消耗

**DNS系统如同互联网中的分布式数据库**，其中也存储了一些别的信息

### 5.3 ARP

在数据链路层通信需要了解每一个IP地址所对应的MAC地址

`ARP`是一种解决地址问题的协议，以目标IP地址为线索，用来定位下一个应该接收数据分包的网络设备对应的MAC地址。

`ARP`只适用于`IPv4`，`IPv6`下使用`ICMPv6`代替`ARP`发送邻居探索消息

#### 5.3.2 ARP工作机制

ARP借助ARP请求与ARP响应两种类型的包确定MAC地址

* 源主机广播发送ARP请求包，请求目标主机MAC地址
* 目标主机收到后，将自身MAC地址通过ARP响应返回给源主机

为节约网络流量，可以将收到的MAC地址与IP地址对应关系缓存在ARP缓存表中，下次无需再次发送ARP请求。每次执行ARP时，对应的缓存内容会被清除。在接收ARP请求的主机上，也可以对源主机的MAC地址和IP地址进行缓存，提高效率。缓存具有一定期限，超过期限后，缓存内容将被清除

ARP可以动态进行MAC地址解析，在TCP/IP网络中只要有IP地址即可，无需事先知道MAC地址

#### 5.3.3 IP地址与MAC地址关系

IP地址与MAC地址相互依托

* MAC地址实现数据包在数据链路层的传输，数据链路层使用MAC地址进行传输，MAC地址决定数据包的下一个路由器
* IP地址实现数据包在网络层的传输，网络层可以根据IP地址的网络标识进行层层分组，建立集约机制，减轻交换机压力，实现网络正常通信

#### 5.3.4 其他概念

RARP：反向ARP，即根据MAC地址定位IP地址，需要先架设一台RARP服务器，注册相应MAC地址的IP地址，再于对应MAC地址的设备进行通信，通知其IP地址。

代理ARP：ARP包会被路由器隔离，采用代理ARP的路由器可以将ARP请求转发给临近的网段。由此，两个以上网段的节点可以像在同一个网段中一样通信

### 5.4 ICMP

#### 5.4.1 辅助IP的ICMP

ICMP用于确认网络是否正常工作，以及遇到异常时进行问题诊断

ICMP主要功能：
* 确认IP包是否成功送达目标地址
* 通知在发送过程中IP包被废弃的具体原因，如路径MTU发现
* 改善网络设置等

ICMP消息分类：
* 通知出错原因的错误消息
* 用于诊断的查询消息

#### 5.4.2 主要的ICMP消息

* ICMP目标不可达消息

	IP路由器无法将IP数据包发送给目标地址时，会向发送端主机返回一个目标不可达的ICMP消息，并在其中显示不可达的具体原因

* ICMP重定向消息

	如果路由器发现发送端主机使用次优路径发送数据，其会返回一个ICMP重定向消息，其中包含了最优的路由信息和源数据。下次发送时，发送端主机会直接使用最优路径

	但是但部分情况下，此类消息会引发网络问题，一般不使用

* ICMP超时信息

	TTL为0时，数据包会被丢弃，路由器向发送端返回ICMP超时消息，通知数据包被丢弃

	使用TTL可以控制数据包到达的范围，避免IP包无休止的在网络上被转发

	traceroute应用利用ICMP超时消息，将TTL从1开始递增，获取发送端到接收端整个路径上的路由器IP地址

* ICMP回送消息

	用于进行通信的主机或路由器之间，判断所发送的数据包是否已经成功到达对端的一种消息。

	可以像对端主机发送回送请求的消息ICMP Echo Request Message，也可以接受对端主机发送回来的回送应答消息ICMP Echo Reply Message，ping命令即通过此种方式实现

* ICMP原点抑制消息：一般不使用
* ICMP路由器探索消息

	用于发现与自己相连网络中的路由器，主机发出ICMP路由器请求，路由器返回ICMP路由器公告消息

* ICMP地址掩码消息

	主要用于主机或路由器想要了解子网掩码的情况，向目标主机发出请求消息，接受应答消息

#### 5.4.4 ICMPv6

ICMP在IPv4中仅为辅助作用，但在IPv6中地位更加重要，起到决定性作用

IPv6中的ICMP分为错误消息（0-127）和信息消息（128-255）两种

**邻居探索协议**

邻居请求消息用于查询IP地址与MAC地址的对应关系，并由邻居宣告地址得知MAC地址，使用IPv6的多播地址实现传输

IPv6实现了即插即用，所以没有DHCP服务器也可以实现IP地址的自动获取。
* 没有路由器的网路，使用MAC地址作为链路本地单播地址
* 有路由器的网路，从路由器获得IP地址的前面部分，后面64位有MAC地址进行生成。关于路由器的部分可以使用路由器请求消息与路由器宣告消息进行设置

### 5.5 DHCP

DHCP：只要接入网络，即可自动获取TCP/IP通信所必需的设置，即插即用

#### 5.5.2 工作机制

1. 主机的DHCP客户端向DHCP服务器请求设置IP地址和子网掩码（广播）
2. DHCP服务器通知可以使用的网络设置（单播）
3. 客户端通知想要使用得到的网络设置（广播）
4. 服务器允许使用（单播）

IP地址的分配方式有随机挑选与根据MAC地址固定匹配两种，可以同时使用

DHCP故障会导致整个网段无法进行TCP/IP通信，因此一般架设两台及以上服务器

#### 5.5.3 DHCP中继代理

DHCP中继代理使用一个DHCP服务器，然后在每个网段上设置其DHCP中继代理，可以在服务器上注册每个网段IP地址的分配范围，进行统一管理与维护

* DHCP客户端向DHCP中继代理发送DHCP请求包（广播）
* DHCP中继代理将广播包发给DHCP服务器（单播）
* 服务器向DHCP中继代理返回应答（单播）
* DHCP中继代理将应答转发给客户端（单播）

从而实现**不在一个数据链路上也可以统一分配和管理IP地址**

### 5.6 NAT

NAT(Network Address Translator)是指在本地网络中使用私有地址，在连接互联网时转而使用全局IP地址的技术

NART：在NAT的基础上附加端口号的转换

NAT实质上是为解决IPv4地址枯竭开发的技术，但是IPv6中为了提高网络安全也用到NAT，**IPv4与IPv6通信使用NAT-PT**

#### 5.6.2 NAT工作机制

私有地址向互联网发送消息时，途中的NAT服务器会自动生成一张转换地址表，将私有地址转换为全局IP地址，然后再发送数据。发过来NAT服务器收到数据包后会根据表中映射关系，将目的地址转换为私有地址，再转发数据包

当私有网络中多台主机同时与外部通信时，仅依靠地址转换无法起到节约全局IP地址的作用，此时需要使用NART技术，将私有地址+端口号一起转换为全局IP地址+端口号，依靠端口号的不同进行发送方的区分。

转换表在NAT服务器上自动生成

#### 5.6.4 NAT的潜在问题

NAT依赖于自己的转换表，其限制在于：
* 无法从NAT外部向内部服务器建立连接
* 生成转换表需要开销
* NAT异常重启时所有TCP连接会被重置

主要问题为无法从外接向服务器内部建立连接，目前解决办法为通信前，服务器内侧的主机先向服务器发送一个虚拟网络包，使得服务器自动生成转换表，称为NAT穿越

NAT技术需要维护转发表，使得IP协议变为面向连接，并且涉及到更改端口号的操作，违反了传统网络分层模型，破坏了各层独立原则。

### 5.7 IP隧道

IP隧道即在网络层首部后继续追加网络层首部的通信方式。

其应用场景之一即IPv6网络之间通过支持IPv4的网络进行通信，将IPv6的包统合为一个数据，再为其追加一个IPv4的首部之后转发给目标地址

其他应用场景：
* Mobile IP
* 多播包的转播
* IPv4网络中传送IPv6的包
* IPv6的网络中传送IPv4的包
* 数据链路帧通过IP层发送

### 5.8 其他IP相关技术

#### 5.8.1 IP多播相关技术

通过MLD(`Multicast Listener Discovery`)确认接收端是否存在，是IPv4中IGMP和IPv6中ICMPv6的重要功能之一，没有接收端，发送多播消息会造成网络流量的浪费。

MLD两大作用：
* 向路由器表明想要接收多播消息，并通知想接受多播的地址
* 向交换集线器通知想要接收多播的地址，此功能也称为IGMP(MLD)探听。避免交换集线器将多播帧发送到所有端口上，不再向毫无关系的端口发送多播帧，降低网络负荷。

#### 5.8.2 IP任播

IP任播是指为提供同一种服务的服务器配置同一个IP地址，并与最近的服务器进行通信的方法。如DNS根域名服务器

IP任播无法保证每次都能与相同的主机建立连接，对TCP或UDP中要求连续多个包通信的情况存在问题

#### 5.8.3 通信质量控制

IP协议是尽力而为，没有通信质量保证。网络发生拥塞（收敛）时，路由器和集线器队列溢出，会出现大量丢包影响性能。

因此提出在尽力而为前提下，对于特殊的包进行优先处理，以保证通信质量。

* IntServ：针对**特定应用**间通信进行质量控制的一种机制。特定应用是指源IP地址，目标IP地址，源端口，目标端口和协议号完全一致。协议复杂，实用性差

* DiffServ：针对**特定网络**进行粗粒度的通信质量控制，实用性较好

#### 5.8.4 显式拥塞通知

网络发生拥塞时，发送主机应该减少数据报的发送量。TCP协议中的拥塞控制是通过数据包的实际损坏判断是否发生拥塞，无法在损坏前减少数据包发送量，因此增加IP层显式拥塞控制ENC。

ENC机制：
* 拥塞检查在网络层进行，在发送包的IP首部中记录路由器是否遇到拥塞
* 拥塞通知在传输层进行，在返回包的TCP首部中通知是否发生拥塞，避免遇到不支持拥塞控制的协议，如UDP

两层的互相协助实现拥塞通知功能。发送包为发送端向目标主机发送的数据，返回包为目标主机发送的应答回执

#### 5.8.5 Mobile IP

Mobile IP使主机所连接的子网IP发生变化时，主机IP地址保持不变。

否则一旦移动设备连接的子网发生变化，其IP地址也会变化，则无法通过TCP继续通信，UDP协议也存在类似问题

**Mobile IP的本质是采用IP隧道的方式进行通信**

* 移动设备通过外部代理发送转发数据包向归属代理通知自己的位置
* 之后归属代理收到发送给移动主机IP的数据包后使用IP隧道发送给外部代理
* 外部代理收到数据包后转发给移动设备

由此移动设备可以不改变IP地址进行通信，有点类似于移动通信网络。

目前问题在Mobile IPv6中得到相应解决：
* 没有外部代理无法通信：外部代理由市县Mobile IPv6移动主机自己承担
* IP包成三角形路径转发效率不高：可以不经由鬼事代理进行直接通信
* 部分网络会丢弃发送端IP地址不在自己域的数据包(当移动设备在外部代理下时，移动设备IP不在外部代理域下)：IPv6首部源地址赋予移动地址，防止防火墙丢弃

### 总结

第五章主要讲述了围绕IP的其他协议，包括有：
* DNS，域名的构成，DNS解析过程
* ARP，ARP工作机制，IP地址与MAC地址关系，代理ARP
* ICMP，ICMP功能，ICMP消息种类，ICMPv6邻居探索消息
* DHCP，DHCP工作原理，DHCP中继代理统一管理
* NAT，所解决问题，NART，潜在问题
* IP隧道与Mobile IP
* 显式拥塞控制，多播任播