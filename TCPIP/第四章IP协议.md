## IP协议

IP协议位于网路层，主要负责将数据包发送给最终的目标计算机

### 4.1 IP即网际协议

IP，包括IPv4与IPv6，位于网络层

**网络层主要作用为实现终端节点之间的通信，也称为点对点通信**

数据链路层主要作用是在互连同一种数据链路的节点之间进行包传递，当跨域多种数据链路时，就需要借助网络层，网络层可以跨域不同的数据链路

网络层与数据链路层关系：
* 数据链路层提供直接连接的两个设备之间的通信能力
* 网络层提供在没有直接连接的两个网络之间进行通信传输

### 4.2 IP基础知识

IP层分为三大模块：IP寻址、路由、IP分包与组包

#### IP地址属于网络层地址

MAC地址是用来表示同一个链路中不同计算机的一种标识码

IP地址是用于在连接到网路中的所有主机中识别出进行通信的目标地址，所有主机和路由器都必须设定自己的IP地址，无论其与那种数据链路相连，IP地址形式均保持不变

无需连接到网络层的设备不需要设置IP地址，如网桥、交换集线器（以太网交换机）等物理层或数据链路层数据包转发设备

#### 4.2.2 路由控制

路由控制是指将分组数据发送到最终目标地址的功能

跳是指网络中的一个区间，一跳是指利用数据链路层一下分层的功能传输数据帧的一个区间。**以太网使用MAC地址传输数据帧，一跳指从源MAC地址到目标MAC地址之间传输帧的区间**

**多跳路由**：多跳路由是指主机或路由器在转发IP数据包时只指定下一个路由器或主机，而不是将所有通路全部指定出来。每个区间在转发IP数据包时，均会指定下一跳的操作，直至包到达最终目标地址

**路由控制表**：路由控制表决定IP数据下一步应该发送给哪个路由器，IP包根据这个路由表在各个数据链路上传输

#### 4.2.3 数据链路的抽象化

IP是实现多种数据链路之间通信的协议，不同数据链路各有特点。

IP协议可以对数据链路层进行抽象化，使得上层协议忽略底层网路构造的细节

#### 4.2.4 IP的无连接性

IP是面向无连接的，不需要建立与对端目标地址之间的连接，需要发送数据时，立刻就会发送出去。IP层提供尽力服务，不做收到与否的验证

无连接优点：简化 + 提速

面向连接相对复杂，管理连接比较繁琐，每次通信前都需要建立连接，降低处理速度。需要面向连接服务时，可以委托上一层提供

**为了提高可靠性，上一层的TCP采用面向连接的处理方式**。TCP负责保证对端主机确实收到数据，进行数据查收的验证

IP与TCP分离的必要性：简化协议实现，明确每种协议作用与责任，同时有利于之后的扩展与优化

### 4.3 IP地址的基础知识

IP地址是TCP/IP通信的基石

#### 4.3.1 IP地址定义

IPv4地址为32位，为方便表示，将其每8位位为一组，分割为4组，使用十进制标识，以`.`隔开

每台主机上的每块网卡都配置了相应的IP地址，通常一块网卡只设置一个IP地址，路由器需要配置两个以上的网卡，故需要设置两个以上的IP地址

**IP地址由网络标识和主机标识两部分组成**
* 网络标识(网络地址)：网络标识在数据链路的每个段配置不同的值，相互连接的每个段网络地址不重复，同一个段内相连的主机网络地址相同
* 主机标识(主机地址)：主机标识不允许在同一个网段中重复出现

#### 4.3.3 IP地址分类

* A类地址

A类地址是首位以0开头的地址

第1位到第8位是它的网络地址，后24位是主机地址，一个网段可以容纳2^24-2台主机

* B类地址

B类地址是前两位是`10`的地址

第1位到第16位是它的网络地址，后16位是主机地址，一个网段可以容纳2^16-2台主机

* C类地址

C类地址是前三位是`110`的地址

第1位到第24位是它的网络地址，后8位是主机地址，一个网段可以容纳2^8-2(254)台主机

* D类地址

D类地址是前四位是`1110`的地址

第1位到第32位是它的网络地址，D类地址没有主机标识，常被用于多播

**NOTE**

主机标识不可全部为0或全部为1，全部为0表示对应的网络地址或IP地址不可获知，全部为1的主机地址常作为广播地址。因此每种地址的主机地址数量计算时都要减去这两种情况

#### 4.3.4 广播地址

广播地址用于同一个链路中相互连接的主机之间发送数据包。

**将IP地址中主机地址部分全部置为1即为广播地址**

广播分为本地广播和直接广播
* 本地广播：在本网络内的广播称为本地广播，路由器会屏蔽本地广播包，不会向外部网络链路转发
* 直接广播：不同网络间的广播称为直接广播，可以向别的网络发送该网络内的广播包，实现对该网络所有主机的广播

	直接广播有一定的安全问题，多数情况下会在路由器上设置为不转发

#### 4.3.5 IP多播

多播用于将包发送给特定组内的所有主机，**直接使用IP协议，不存在可靠传输**

多播技术出现前，通常使用广播方式实现此功能，然后在主机的IP层上判断是否需要接收数据，造成流量浪费

多播优点：
* 提高效率：只向网络传递一个多播数据包，路由器将复制该数据包并将其传递到多个主机，减少发送端工作
* 可以穿透路由：广播不能穿透路由，只能在同一个网络中使用
* 不浪费过多流量：只针对必要的主机组发送数据包

**多播使用D类地址，除固定前四位外，剩下28位是多播的组编号**。`224.0.0.0~224.0.0.255`，这是为路由协议和其它用途保留的地址，在同一个链路内使用，路由器并不转发属于此范围的IP包

使用多播时需要将路由器与主机加入到一定的IP组中，详见相关文档

#### 4.3.6 子网掩码

使用子网+子网掩码的方式，将原来A类、B类或C类地址中主机地址部分用作子网地址，可以将原网络分为多个物理网络，实现更小粒度划分

**IP地址使用子网掩码，可以自由的定位自身的网络标识长度，不再受制于网络类型**

子网掩码也是32位，对应IP地址网络标识部分全部为1，对应IP地址主机标识部分全部为0

子网掩码的两种表示方式：
* 172.20.100.52     255.255.255.192
* 172.20.100.52/26

#### 4.3.7 CIDR与VLSM

CIDR：采用任意长度分割IP地址的网络标识与主机标识，有效利用IPv4地址

使用CIDR后，再采用子网掩码的形式，可以将两个不同的IP划分到同一个网络下。

子网掩码最初为网络内部固定长度，为了更高效使用IP地址，需要子网掩码可以根据网络内主机数量可以进行调整，即可变长子网掩码VLSM

CIDR与VLSM相对缓解了IP地址不够的问题，但是绝对数量不足的问题需要使用IPv6的方式进行解决。

#### 全局地址与私有地址

