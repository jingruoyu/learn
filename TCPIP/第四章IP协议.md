## IP协议

IP协议位于网路层，主要负责将数据包发送给最终的目标计算机

### 4.1 IP即网际协议

IP，包括IPv4与IPv6，位于网络层

**网络层主要作用为实现终端节点之间的通信，也称为点对点通信**

数据链路层主要作用是在互连同一种数据链路的节点之间进行包传递，当跨域多种数据链路时，就需要借助网络层，网络层可以跨域不同的数据链路

网络层与数据链路层关系：
* 数据链路层提供直接连接的两个设备之间的通信能力
* 网络层提供在没有直接连接的两个网络之间进行通信传输

### 4.2 IP基础知识

IP层分为三大模块：IP寻址、路由、IP分包与组包

#### IP地址属于网络层地址

MAC地址是用来表示同一个链路中不同计算机的一种标识码

IP地址是用于在连接到网路中的所有主机中识别出进行通信的目标地址，所有主机和路由器都必须设定自己的IP地址，无论其与那种数据链路相连，IP地址形式均保持不变

无需连接到网络层的设备不需要设置IP地址，如网桥、交换集线器（以太网交换机）等物理层或数据链路层数据包转发设备

#### 4.2.2 路由控制

路由控制是指将分组数据发送到最终目标地址的功能

跳是指网络中的一个区间，一跳是指利用数据链路层一下分层的功能传输数据帧的一个区间。**以太网使用MAC地址传输数据帧，一跳指从源MAC地址到目标MAC地址之间传输帧的区间**

**多跳路由**：多跳路由是指主机或路由器在转发IP数据包时只指定下一个路由器或主机，而不是将所有通路全部指定出来。每个区间在转发IP数据包时，均会指定下一跳的操作，直至包到达最终目标地址

**路由控制表**：路由控制表决定IP数据下一步应该发送给哪个路由器，IP包根据这个路由表在各个数据链路上传输

#### 4.2.3 数据链路的抽象化

IP是实现多种数据链路之间通信的协议，不同数据链路各有特点。

IP协议可以对数据链路层进行抽象化，使得上层协议忽略底层网路构造的细节

#### 4.2.4 IP的无连接性

IP是面向无连接的，不需要建立与对端目标地址之间的连接，需要发送数据时，立刻就会发送出去。IP层提供尽力服务，不做收到与否的验证

无连接优点：简化 + 提速

面向连接相对复杂，管理连接比较繁琐，每次通信前都需要建立连接，降低处理速度。需要面向连接服务时，可以委托上一层提供

**为了提高可靠性，上一层的TCP采用面向连接的处理方式**。TCP负责保证对端主机确实收到数据，进行数据查收的验证

IP与TCP分离的必要性：简化协议实现，明确每种协议作用与责任，同时有利于之后的扩展与优化

### 4.3 IP地址的基础知识

IP地址是TCP/IP通信的基石

#### 4.3.1 IP地址定义

IPv4地址为32位，为方便表示，将其每8位位为一组，分割为4组，使用十进制标识，以`.`隔开

每台主机上的每块网卡都配置了相应的IP地址，通常一块网卡只设置一个IP地址，路由器需要配置两个以上的网卡，故需要设置两个以上的IP地址

**IP地址由网络标识和主机标识两部分组成**
* 网络标识(网络地址)：网络标识在数据链路的每个段配置不同的值，相互连接的每个段网络地址不重复，同一个段内相连的主机网络地址相同
* 主机标识(主机地址)：主机标识不允许在同一个网段中重复出现

#### 4.3.3 IP地址分类

* A类地址

A类地址是首位以0开头的地址

第1位到第8位是它的网络地址，后24位是主机地址，一个网段可以容纳2^24-2台主机

* B类地址

B类地址是前两位是`10`的地址

第1位到第16位是它的网络地址，后16位是主机地址，一个网段可以容纳2^16-2台主机

* C类地址

C类地址是前三位是`110`的地址

第1位到第24位是它的网络地址，后8位是主机地址，一个网段可以容纳2^8-2(254)台主机

* D类地址

D类地址是前四位是`1110`的地址

第1位到第32位是它的网络地址，D类地址没有主机标识，常被用于多播

**NOTE**

主机标识不可全部为0或全部为1，全部为0表示对应的网络地址或IP地址不可获知，全部为1的主机地址常作为广播地址。因此每种地址的主机地址数量计算时都要减去这两种情况

#### 4.3.4 广播地址

广播地址用于同一个链路中相互连接的主机之间发送数据包。

**将IP地址中主机地址部分全部置为1即为广播地址**

广播分为本地广播和直接广播
* 本地广播：在本网络内的广播称为本地广播，路由器会屏蔽本地广播包，不会向外部网络链路转发
* 直接广播：不同网络间的广播称为直接广播，可以向别的网络发送该网络内的广播包，实现对该网络所有主机的广播

	直接广播有一定的安全问题，多数情况下会在路由器上设置为不转发

#### 4.3.5 IP多播

多播用于将包发送给特定组内的所有主机，**直接使用IP协议，不存在可靠传输**

多播技术出现前，通常使用广播方式实现此功能，然后在主机的IP层上判断是否需要接收数据，造成流量浪费

多播优点：
* 提高效率：只向网络传递一个多播数据包，路由器将复制该数据包并将其传递到多个主机，减少发送端工作
* 可以穿透路由：广播不能穿透路由，只能在同一个网络中使用
* 不浪费过多流量：只针对必要的主机组发送数据包

**多播使用D类地址，除固定前四位外，剩下28位是多播的组编号**。`224.0.0.0~224.0.0.255`，这是为路由协议和其它用途保留的地址，在同一个链路内使用，路由器并不转发属于此范围的IP包

使用多播时需要将路由器与主机加入到一定的IP组中，详见相关文档

#### 4.3.6 子网掩码

使用子网+子网掩码的方式，将原来A类、B类或C类地址中主机地址部分用作子网地址，可以将原网络分为多个物理网络，实现更小粒度划分

**IP地址使用子网掩码，可以自由的定位自身的网络标识长度，不再受制于网络类型**

子网掩码也是32位，对应IP地址网络标识部分全部为1，对应IP地址主机标识部分全部为0

子网掩码的两种表示方式：
* 172.20.100.52     255.255.255.192
* 172.20.100.52/26

#### 4.3.7 CIDR与VLSM

CIDR：采用任意长度分地割IP址的网络标识与主机标识，有效利用IPv4地址

使用CIDR后，再采用子网掩码的形式，可以将两个不同的IP划分到同一个网络下。

子网掩码最初为网络内部固定长度，为了更高效使用IP地址，需要子网掩码可以根据网络内主机数量可以进行调整，即可变长子网掩码VLSM

CIDR与VLSM相对缓解了IP地址不够的问题，但是绝对数量不足的问题需要使用IPv6的方式进行解决。

#### 4.3.8 全局地址与私有地址

起初，互联网上的任意一台主机或路由器都必须由一个唯一的IP地址，IP地址出现冲突时，发送端无法判断将数据包发送给哪个地址，并且会带来IP地址不足的问题

但是**独立网络中的设备只要在网络中地址唯一即可**，无需全网络地址唯一，可以不用考虑互联网即可配置相应IP地址，即**私有网络内的IP地址**

私有网络IP地址范围：
* A类地址：10.0.0.0 ~ 10.255.255.255 /8
* B类地址：172.16.0.0 ~ 172.31.255.255 /12
* C类地址：192.168.0.0 ~ 192.168.255.255 /16

此范围内的IP地址属于私有IP，在此之外的IP地址属于全局IP，全局IP需要在整个互联网范围内保持唯一，私有IP只需要在同一个域中保持唯一

私有IP结合NAT技术，配置私有IP的主机可以通过路由器与配置全局地址的互联网主机实现通信

但是解决IP地址不足问题的根本途径还是**IPv6**

全局地址由专门机构进行管理，使用需要进行申请

### 4.4 路由控制

数据包通过**路由控制表**确定转发方向，发往目标地址

路由控制表形成方式：
* 静态路由控制：管理员手动设置路由控制表
* 动态路由控制：路由器与其他路由器互相交换信息时自动刷新，通过路由协议制作路由控制表，该协议不属于IP协议

#### 4.4.1 IP地址与路由控制

**IP地址的网络部分用于路由控制**

路由控制表中记录着网络地址与下一跳应该发送到的的路由器地址。发送IP包过程为
* 确定IP包首部中的目标地址
* 从路由控制表中找到与该地址具有相同网络地址的记录，根据该记录将IP包转发给相应的下一个路由器

	如果存在多条相同的网络地址记录，以最吻合的，即相同位数最多的为准

其他概念：
* 默认路由：

	一张路由表中包含所有网络和及其子网信息较为浪费，故采用默认路由的形式作为默认转发选项

	默认路由一般标记为0.0.0.0/0或default，可以和任何IP地址进行匹配

* 主机路由：

	`IP地址/32`被称为主机路由，即IP地址的所有位都将参与路由，而不是基于该地址的网络地址部分

	主机路由多用于不希望通过网络地址路由的情况

* 环回地址

	环回地址是在同一台计算机的程序之间进行网络通信时所使用的一个默认地址，IP为`127.0.0.1`，主机名为`localhost`

	使用这个IP或主机名时，数据包不会流向网络

#### 4.4.2 路由控制表的聚合

利用网络地址的比特分布可以有效地进行分层配置，聚合路由表，减少路由表条目，提高性能

即在网络地址的基础上再进行聚合

### 4.5