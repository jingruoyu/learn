## TCP与UDP

### 6.1 传输层的作用

* TCP面向连接，可靠地流协议，提供可靠地通信传输
* UDP提供不可靠的通信传输，常用于广播和细节控制交给应用的服务

传输层使用端口号区分应用层中所要进行处理的具体程序

在传统的C/S框架下，服务端会启动一个超级守护进程，即互联网守护进程inetd，该进程在接收到客户端请求后会根据目标端口号fork新的进程并转换为所需的各个服务端程序，也称守护进程

TCP与UDP需要根据需求进行相应选择

**套接字Socket**

操作系统提供了很多类库，即API，应用在使用TCP或UDP通信时，会广泛使用到套接字(socket)的API，使用其可以设置对端的IP地址、端口号，并实现数据的发送与接收

### 6.2 端口号

* MAC地址用于识别同一个数据链路中不同的主机
* IP地址用于识别TCP/IP网络中互连的主机和路由器
* 端口号用于识别同一台计算机中进行通信的不同应用程序，也称程序地址

**通过源IP地址、目标IP地址、源端口号、目标端口号与协议号五个信息识别是否为一个通信**，只要其中某一项不同，则被认为是其他通信

#### 6.2.4 端口号如何确定

* 标准既定的端口号

每一个应用程序都有其指定的端口号，但是不可以随意使用任何一个端口号，每个端口号都有其对应的使用目的

知名端口号：部分广泛使用的应用协议所使用的端口号是固定的，其被称为知名端口号，应用程序应该避免使用知名端口号进行既定目的之外的通信，避免冲突。

* 时序分配法

也称动态分配法，客户端应用程序不用设置端口号，交由操作系统分配。操作系统为每个应用程序分配互不冲突的端口号，对端口号进行动态管理。

#### 6.2.5 端口号与协议

端口号由其使用的传输层协议决定，不同的传输层协议可以使用相同的端口号，但是使用目的各不相同，端口号上的处理是根据每个传输协议的不同进行处理的，互相独立不受影响。

知名端口号与传输层协议并无关系，只要端口号一致都将分配同一种程序进行处理。如TCP和UDP都使用53号端口进行DNS服务

### 6.3 UDP

UDP：User Datagram Protocol，不提供复杂的控制机制，利用IP提供**面向无连接通信服务**，并且将应用程序发来的数据在收到的那一刻，立刻按照原样发送到网络上的一种机制。

UDP无法进行拥塞控制，无法处理丢包，不负责重发，包顺序错乱无法纠正，只提供传输层协议最基本功能，细节控制需要交由应用程序。

UDP面向无连接，可以随时发送数据，简单高效，应用场景：
* 包总量较少的通信（DNS、SNMP等）
* 视频、音频等即时通信
* 限定于LAN等特定网络中的应用通信
* 广播通信（广播、多播）

### 6.4 TCP

TCP：充分实现数据传输时各种控制功能，**面向有连接协议**，只在确认通信对端存在时才发送数据，避免流量浪费，在面向无连接的IP层基础上实现高可靠通信

**连接**：各种设备、线路、网络中进行通信的两个应用程序为了相互传递消息而专有的、虚拟的通信线路。一旦建立连接，应用程序间只使用该虚拟线路进行通信，不必考虑IP网络可能存在的各种问题。

TCP负责控制连接的建立、断开、保持等管理工作

TCP可靠传输依赖于：检验和、序列号、确认应答、重发控制、连接管理以及窗口控制等机制

#### 6.4.2 序列号与确认应答

发送端主机数据到达接收端，接收端主机会返回一个ACK确认应答。
* 如果发送端收到确认应答，说明数据成功到达对端
* 如果一段时间没有收到，可能发生数据丢包或ACK丢包，发送端都会认为数据已丢失，进行重发

