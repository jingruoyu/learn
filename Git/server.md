# 服务器上的Git

与他人合作的最佳方法即为建立一个你与合作者们都有权利访问，且可以从那里pull和push数据的公用仓库

一个远程repo通常只是一个bare repository，即一个没有当前工作目录的仓库。因为该仓库仅仅是一个合作媒介，不需要从磁盘检查快照，存放的只有Git的资料。

**裸仓库就是工程目录中.git子目录内容，不包含其他数据**

## 协议

Git可以使用四种不同的协议来传输数据

* 本地协议Local
* HTTP协议
* SSH（Secure Shell）
* Git协议

### 本地协议

本地协议的远程版本库就是同一主机上的另一个目录，常用于团队每个成员都对一个共享文件系统（如一个挂载的NFS）拥有访问权，或者多人公用一台电脑的情况

使用共享文件系统时，可以从本地版本库clone、push或者pull

```
git clone /srv/git/project.git
// 或者
git clone file:///srv/git/project.git
```

当URL明确指定file协议，Git的行为会略有不同

* 如果仅是指定路径，Git会尝试使用硬链接hard link或直接复制所需要的数据
* 如果制定了file协议，Git会触发平时用于网络传输资料的进程，**传输效率会变低**

指定file协议的主要目的是取得一个没有`extraneous references`或`Object`的干净版本库副本，通常是在从其他版本控制系统导入后或一些类似的情况下需要这么做

#### 优点

基于文件系统的版本库相对比较简单，并且直接使用了现有的文件权限和网络访问权限。如果团队已经有共享文件系统，建立版本库会十分容易。将一个空repo放入到共享文件夹，设计读写权限即可

#### 缺点

共享文件夹比较难配置，必须先挂在一个远程磁盘，相较于网络连接的访问方式，配置不方便

**此外如果适用类似于共享挂在的文件系统时，速度不一定是最快的。**访问本地版本库的速度与访问数据的速度是一样的

在同一个服务器上，如果允许Git访问本地硬盘，一般通过NFS访问版本库的速度比SSH访问慢

每个用户都有远程目录的完整shell权限，没有方法可以阻止他们修改或删除Git内部数据或损坏仓库

### HTTP协议

Git中的HTTP通信有两种

* Dumb HTTP：Git 1.6.6版本之前使用

	如果服务器没有提供智能HTTTP服务，Git客户端会尝试使用更简单的`Dumb HTTP`。

	`Dumb HTTP`协议中web服务器仅把空repo当做普通文件看待，其优美之处在于设置起来很简单

* Smart HTTP：Git 1.6.6版本引入

	运行方式和`SSH`以及`Git`协议类似，只是运行在标准的`HTTP/S`端口上并且可以使用各种`HTTP`验证机制。使用起来会比`SSH`协议简单很多，如可以使用`HTTP`协议既有的授权方式

	Smart HTTP可以只使用一个URL
	* 支持`git://`协议一样设置匿名服务
	* 支持`SSH`协议一样提供传输时的授权和加密

	当把数据push到一个需要授权的服务器上时，服务器会提示输入用户名和密码

#### 优点

针对smart HTTP

* 不同的访问方式只需要一个URL
* 服务器只在需要授权时提示输入授权信息

这两个简便性使得Git变得非常简单。相较于SSH协议，第二点避免了SSH密钥对的生成及公钥的上传，对于一些使用者来说具备很大优势

此外HTTPS协议被广泛使用，一般企业防火墙都允许通过

#### 缺点

在服务器上架设HTTPS协议的服务端比SSH更棘手一些

如果在HTTP上使用需要授权的push，相较于SSH管理凭证较为麻烦，但可以借助于一些系统凭证管理器，macOS与windows均有对应工具

### SSH协议

架设Git服务器时常用SSH协议作为传输协议，因为大多数环境下服务器已经支持通过通过SSH访问。SSH协议也是一个验证授权的网络协议，并且因为其普遍性，架设和使用都很容易

SSH，Secure Shell，建立在应用层基础上的安全协议，专为远程登录会话和其他网络服务提供安全性，适用于多种平台，几乎所有的Unix平台都可以运行SSH

SSH协议优点

* 所有传输数据加密，防止中间人攻击，避免ftp、pop、telnet明文传送口令与数据
* 传输的数据经过压缩，加快传输速度

SSH可以提供两种级别的安全验证

* 基于口令的安全验证：此时也有可能受到中间人攻击
* 基于秘钥的安全验证：将公钥存放于目标服务器上

	* 客户端和服务端进行key exchange，此时双方都有一个key和hash
	* 使用这两个值生成secret key，后续使用这个key进行对称加密
	* 服务端向客户端发送自己的public key
	* 客户端通过在自己的known_hosts里面查找这个public_key来验证服务器身份

#### 优点

* 简单，使用十分常见
* 安全，所有传输数据都经过授权和加密
* 高效，与HTTPS相似，传输数据前会尽量压缩数据

#### 缺点

不支持匿名访问Git仓库。即便只是读取数据，使用者也必须通过SSH访问主机。因此不利于开源项目，可能有一部分人仅仅想将repo clone下来查看

### Git协议

Git协议是包含在Git中的一个特殊守护进程，监听9418端口，类似于SSH，但无需任何授权

Git协议没有任何安全措施，要么谁都可以clone这个版本库，要么谁都不能。

因为没有授权机制，所以一般不能通过Git协议push，一旦开放push操作，则任何人都能向这个项目push

#### 优点

网络协议中传输速度最快。使用与SSH相同的数据传输机制，但是省却了加密和授权的开销

#### 缺点

* 缺乏授权机制。

	将Git协议作为repo唯一的手段是不可取的。通常做法是，同时提供Git协议+SSH协议或HTTPS协议，只让少数几个开发者有push权限，其他人通过git访问只读权限

* 搭建复杂

	需要守护进程，需要防护墙开放对应端口